# Interconexión entre Oracle 21c y Oracle 19c

En este escenario, tenemos dos servidores Oracle configurados para establecer una interconexión:

1. **Oracle 19c (Servidor de origen)**
   
   - **Host**: `oracle19c`
   
   - **IP**: `192.168.122.195`
   
   - **Configuración previa**: En este servidor ya se ha configurado una interconexión entre Oracle 19c y PostgreSQL. Además, se han creado tablas del usuario `pablolink`, el cual tiene las tablas de scott creadas, que serán consultadas desde Oracle 21c.

2. **Oracle 21c (Servidor de destino)**
   
   - **Host**: `oracle21c`
   
   - **IP**: `192.168.122.148`
   
   - **Objetivo**: La intención es establecer una interconexión desde Oracle 21c hacia Oracle 19c, para poder consultar las tablas del usuario `pablolink` creadas en el servidor Oracle 19c.

Recalcar, que es completamente indiferente la versión de Oracle para hacer la interconexión entre estos.

## Configuración en Oracle 19c (Servidor Oracle1)

En el servidor Oracle 19c, tenemos que editar el archivo `listener.ora` para que escuche al servidor.
```
oracle@oracle19c:~$ cat /opt/oracle/product/19c/dbhome_1/network/admin/listener.ora 
# listener.ora Network Configuration File: /opt/oracle/product/19c/dbhome_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = oracle19c)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )
```
Previamente a esto, he modificado el archivo `/etc/hosts` para poner la IP (estática) apuntando al hostname:
```
oracle@oracle19c:~$ cat /etc/hosts
127.0.0.1	localhost
127.0.1.1	oracle19c
192.168.122.195	oracle19c
# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

Ahora, tendremos que editar el archivo `tnsnames.ora` para agregar la definición del servicio que será accesible desde Oracle 21c. Podemos poner el nombre que queramos:
```
ORACLE2 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.122.148)(PORT = 1521))
    (CONNECT_DATA =
      (SERVICE_NAME = ORCLCDB)
    )
  )
```

Reiniciamos el servicio:
```
oracle@oracle19c:~$ lsnrctl stop

LSNRCTL for Linux: Version 19.0.0.0.0 - Production on 17-NOV-2024 21:00:53

Copyright (c) 1991, 2019, Oracle.  All rights reserved.

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=oracle19c)(PORT=1521)))
The command completed successfully
```
```
oracle@oracle19c:~$ lsnrctl start

LSNRCTL for Linux: Version 19.0.0.0.0 - Production on 17-NOV-2024 21:00:57

Copyright (c) 1991, 2019, Oracle.  All rights reserved.

Starting /opt/oracle/product/19c/dbhome_1/bin/tnslsnr: please wait...

TNSLSNR for Linux: Version 19.0.0.0.0 - Production
System parameter file is /opt/oracle/product/19c/dbhome_1/network/admin/listener.ora
Log messages written to /opt/oracle/diag/tnslsnr/oracle19c/listener/alert/log.xml
Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=oracle19c)(PORT=1521)))
Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=oracle19c)(PORT=1521)))
STATUS of the LISTENER
------------------------
Alias                     LISTENER
Version                   TNSLSNR for Linux: Version 19.0.0.0.0 - Production
Start Date                17-NOV-2024 21:00:57
Uptime                    0 days 0 hr. 0 min. 0 sec
Trace Level               off
Security                  ON: Local OS Authentication
SNMP                      OFF
Listener Parameter File   /opt/oracle/product/19c/dbhome_1/network/admin/listener.ora
Listener Log File         /opt/oracle/diag/tnslsnr/oracle19c/listener/alert/log.xml
Listening Endpoints Summary...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=oracle19c)(PORT=1521)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))
Services Summary...
Service "PSQLU" has 1 instance(s).
  Instance "PSQLU", status UNKNOWN, has 1 handler(s) for this service...
The command completed successfully
```

## Configuración en Oracle 21c (Servidor Oracle2)

En el servidor Oracle 21c, tendremos que configurar el archivo `listener.ora` para que escuche al otro servidor. Al igual que anteriormente debemos añadir en el `/etc/hosts` la dirección IP (estática).

```
oracle@oracle21c:~$ cat /etc/hosts
127.0.0.1	localhost
127.0.1.1	oracle21c
192.168.122.148	oracle21c
# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

```
oracle@oracle21c:~$ cat /opt/oracle/product/21c/dbhome_1/network/admin/listener.ora 
LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = oracle21c)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )
```

Seguidamente, editamos el archivo `tnsnames.ora` en Oracle 21c para agregar el alias de conexión hacia Oracle 19c (ORACLE2).
```
oracle@oracle21c:~$ cat /opt/oracle/product/21c/dbhome_1/network/admin/tnsnames.ora
ORACLE2 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.122.195)(PORT = 1521))
    (CONNECT_DATA =
      (SERVICE_NAME = ORCLCDB)
    )
  )
```

Y reiniciamos:
```
oracle@oracle21c:~$ lsnrctl stop && lsnrctl start

LSNRCTL for Linux: Version 21.0.0.0.0 - Production on 17-NOV-2024 20:47:48

Copyright (c) 1991, 2021, Oracle.  All rights reserved.

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=oracle21c)(PORT=1521)))
The command completed successfully

LSNRCTL for Linux: Version 21.0.0.0.0 - Production on 17-NOV-2024 20:47:48

Copyright (c) 1991, 2021, Oracle.  All rights reserved.

Starting /opt/oracle/product/21c/dbhome_1/bin/tnslsnr: please wait...

TNSLSNR for Linux: Version 21.0.0.0.0 - Production
System parameter file is /opt/oracle/homes/OraDBHome21cEE/network/admin/listener.ora
Log messages written to /opt/oracle/diag/tnslsnr/oracle21c/listener/alert/log.xml
Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=oracle21c)(PORT=1521)))
Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=oracle21c)(PORT=1521)))
STATUS of the LISTENER
------------------------
Alias                     LISTENER
Version                   TNSLSNR for Linux: Version 21.0.0.0.0 - Production
Start Date                17-NOV-2024 20:47:48
Uptime                    0 days 0 hr. 0 min. 0 sec
Trace Level               off
Security                  ON: Local OS Authentication
SNMP                      OFF
Listener Parameter File   /opt/oracle/homes/OraDBHome21cEE/network/admin/listener.ora
Listener Log File         /opt/oracle/diag/tnslsnr/oracle21c/listener/alert/log.xml
Listening Endpoints Summary...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=oracle21c)(PORT=1521)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))
The listener supports no services
The command completed successfully
```

Ahora, haremos una comprobación para ver que todo vaya bien:
```
oracle@oracle21c:~$ tnsping ORACLE2

TNS Ping Utility for Linux: Version 21.0.0.0.0 - Production on 17-NOV-2024 20:48:00

Copyright (c) 1997, 2021, Oracle.  All rights reserved.

Used parameter files:
/opt/oracle/homes/OraDBHome21cEE/network/admin/sqlnet.ora

TNS-03505: Failed to resolve name
```

Y como podemos ver nos ha fallado. Este error indica que Oracle 21c no ha podido resolver el alias de conexión ORACLE2 definido en el archivo `tnsnames.ora` a la dirección IP y detalles del servicio correspondientes. 

Este tipo de error suele ocurrir cuando hay un problema con la configuración del archivo `tnsnames.ora`, el cual Oracle usa para encontrar las definiciones de los servicios a los que se puede conectar.

Como vemos el error indica el fichero `sqlnet.ora`, este archivo contiene configuraciones que definen cómo Oracle maneja las conexiones de red, incluyendo las fuentes de nombres que utiliza para resolver los alias de conexión.

En este caso, el archivo contiene la siguiente línea:
```
oracle@oracle21c:~$ cat /opt/oracle/homes/OraDBHome21cEE/network/admin/sqlnet.ora
# sqlnet.ora Network Configuration File: /opt/oracle/homes/OraDBHome21cEE/network/admin/sqlnet.ora
# Generated by Oracle configuration tools.

NAMES.DIRECTORY_PATH= (TNSNAMES, ONAMES, HOSTNAME)
```

Por lo tanto, voy a ver que tiene la variable `$TNS_ADMIN`:
```
oracle@oracle21c:~$ echo $TNS_ADMIN


```

Y como vemos, no hay nada. Esta variable es la que Oracle usa para localizar los archivos de configuración de red, como `tnsnames.ora` y `sqlnet.ora`. En este caso, no se mostró ningún valor, lo que indica que la variable `TNS_ADMIN` no está configurada.

Por lo tanto, añadimos la variable al `~/.bashrc`
```
export TNS_ADMIN=/opt/oracle/product/21c/dbhome_1/network/admin/
```
Y lo recargamos:
```
source ~/.bashrc
```

Volvemos a ejecutar el tnsping y como vemos ya nos funciona a la perfección:
```
oracle@oracle21c:~$ tnsping ORACLE2

TNS Ping Utility for Linux: Version 21.0.0.0.0 - Production on 17-NOV-2024 20:49:25

Copyright (c) 1997, 2021, Oracle.  All rights reserved.

Used parameter files:
/opt/oracle/homes/OraDBHome21cEE/network/admin/sqlnet.ora


Used TNSNAMES adapter to resolve the alias
Attempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.122.195)(PORT = 1521)) (CONNECT_DATA = (SERVICE_NAME = ORCLCDB)))
OK (0 msec)
```

Ahora creamos el enlace de base de datos en Oracle 21c hacia Oracle 19c:
```
SQL> create database link oracle19c_link
  2  connect to pablolink identified by password
  3  using 'ORACLE2';
```

Donde:

- `oracle19c_link`: es el nombre identificativo para el link.

- `pablolink/password`: son las credenciales del usuario del servidor 19c al que queremos conectarnos.

- `ORACLE2`: es el alias que anteriormente hemos definido.

Y ahora tan solo nos queda realizar la consulta:
```
SQL> SELECT * FROM dept@oracle19c_link;

    DEPTNO DNAME	  LOC
---------- -------------- -------------
	10 ACCOUNTING	  NEW YORK
	20 RESEARCH	  DALLAS
	30 SALES	  CHICAGO
	40 OPERATIONS	  BOSTON
```

Y listo, ya tendríamos hecho la interconexión entre los dos servidores de Oracle.